# Newsletter AI Agent

AI-powered pipeline that plans sections, (optionally) researches via Tavily, drafts with inline citations, renders HTML via Jinja2, and can email the final newsletter.

> **Note:** Run commands from the **repo root** (e.g., `/workspaces/Newsletter_AI_Agent`).

---

## Features

- **Smart planning** – table of contents based on topic, tone, and audience  
- **Research integration (optional)** – Tavily search → inline `<a href>` citations  
- **Quality controls** – per-section and global word limits  
- **HTML rendering** – Jinja2 template → `output/newsletter.html`  
- **Email sending (optional)** – SMTP support  
- **Deterministic outputs** – files written to a known `output/` folder  
  > Content is generated by an LLM, so it is **not deterministic**; only the output locations/filenames are.

---

## Requirements

- **Python 3.10+**
- LLM provider key (**one of**):
  - `OPENAI_API_KEY` (default)
  - `ANTHROPIC_API_KEY` (if `--provider anthropic`)
- *(Optional, recommended)* `TAVILY_API_KEY` for richer research/citations

---

## Quick Start

```bash
# 1) Create & activate a virtualenv
python -m venv .venv
# macOS/Linux
. .venv/bin/activate
# Windows (PowerShell)
# .\.venv\Scripts\Activate.ps1

# 2) Install dependencies
pip install -r requirements.txt

# 3) Configure environment variables
cp .env.example .env
# edit .env and set OPENAI_API_KEY (or ANTHROPIC_API_KEY), etc.

# 4) Generate a newsletter (example)
python -m newsletter --topic "AI/ML developments" --tone "Professional" --audience "Researchers"

# Outputs:
# - output/subject.txt
# - output/newsletter.html
````

> Tip: add `--output-dir ./out` to write files elsewhere.

---

## Configuration (`.env`)

```ini
# LLM
LLM_PROVIDER=openai           # or: anthropic
LLM_MODEL=gpt-4o-mini         # or any supported model

# Keys (set one provider)
OPENAI_API_KEY=sk-...
# ANTHROPIC_API_KEY=...

# Research (optional)
TAVILY_API_KEY=tvly-...

# Content controls
MAX_WORDS=1000
PER_SECTION_WORD_TARGET=180

# Email (optional)
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=your-email@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=Your Name <your-email@gmail.com>
```

---

## CLI Usage

```bash
# Basic
python -m newsletter --topic "AI Safety" --tone "Neutral" --audience "Policy Makers"

# With specific provider/model
python -m newsletter --topic "LLM Ops" --tone "Technical" --audience "Engineers" \
  --provider openai --model gpt-4o-mini

# Custom output directory
python -m newsletter --topic "AI Papers" --tone "Academic" --audience "Researchers" \
  --output-dir ./my-newsletters

# Send via email (requires SMTP_* in .env)
python -m newsletter --topic "AI Weekly" --tone "Professional" --audience "Subscribers" \
  --to alice@example.com bob@example.com --send-email
```

**Key flags**

* `--topic TEXT` (required)
* `--tone TEXT` (required)
* `--audience TEXT` (required)
* `--provider {openai,anthropic}`
* `--model TEXT`
* `--output-dir PATH` (default: `./output`)
* `--to EMAIL [EMAIL ...]`
* `--send-email`

See all options:

```bash
python -m newsletter -h
```

---

## Output

Generated files (default):

```text
output/
├── newsletter.html
└── subject.txt
```

Customize the HTML by editing the template:

```text
newsletter/templates/newsletter.html.j2
```

---

## View Locally

**Option 1: Local server (repo root)**

```bash
python -m http.server --directory output 8000
# Open: http://127.0.0.1:8000/newsletter.html
```

**Option 2: Direct open**

```bash
# macOS
open output/newsletter.html
# Linux
xdg-open output/newsletter.html
# Windows
start output\newsletter.html
```

**Option 3: Cleaner URL**

```bash
cp output/newsletter.html output/index.html
# Now http://127.0.0.1:8000/ works directly (when serving output/)
```

---

## Customization

### Edit HTML Template

Tweak `newsletter/templates/newsletter.html.j2` for:

* branding (logo/header/footer)
* colors/typography
* layout

### Adjust Content Controls

Tune these in `.env`:

* `MAX_WORDS` (global cap)
* `PER_SECTION_WORD_TARGET` (per section cap)

> For email-client compatibility (Gmail/Outlook), consider converting the template to **MJML** or an inline-CSS table layout for production sends.

---

## Email Delivery (optional)

**Gmail (App Password recommended):**

```ini
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USERNAME=you@gmail.com
SMTP_PASSWORD=your-app-password
SMTP_FROM=Your Name <you@gmail.com>
```

**Dry-run with a local SMTP debug server (no real emails):**

```bash
pip install aiosmtpd
python -m aiosmtpd -n -l 127.0.0.1:1025 &
SMTP_PID=$!

export SMTP_HOST=127.0.0.1 SMTP_PORT=1025 SMTP_USERNAME=foo SMTP_PASSWORD=bar SMTP_FROM="Test <test@example.com>"

python -m newsletter --topic "Test" --tone "Casual" --audience "Testing" \
  --to your-email@example.com --send-email --output-dir output

kill $SMTP_PID
```

---

## Publish to GitHub Pages

**Docs folder method:**

```bash
mkdir -p docs
cp output/newsletter.html docs/index.html
git add docs/
git commit -m "Publish newsletter"
git push
# GitHub → Settings → Pages → Source: main /docs
```

**`gh-pages` branch method:**

```bash
git checkout --orphan gh-pages
git rm -rf .
cp output/newsletter.html index.html
git add index.html
git commit -m "Publish newsletter"
git push -u origin gh-pages
# GitHub → Settings → Pages → Source: gh-pages / root
```

---

## Project Structure

<!-- BEGIN:PROJECT_TREE -->

```text
.
├── .cache/
│   └── tavily/
├── .env
├── .env.example
├── .gitignore
├── README.md
├── requirements.txt
├── newsletter/
│   ├── __init__.py
│   ├── __main__.py
│   ├── config.py
│   ├── emailer.py
│   ├── llm.py
│   ├── models.py
│   ├── pipeline.py
│   ├── search.py
│   └── templates/
│       └── newsletter.html.j2
└── output/
    ├── newsletter.html
    └── subject.txt
```

<!-- END:PROJECT_TREE -->

---

## Troubleshooting

**`ModuleNotFoundError: No module named 'dotenv'`**  
Install dependencies inside your venv:
```bash
pip install -r requirements.txt
````

**`ValidationError` about `HttpUrl` keys in `sources`**
Fixed in `pipeline.py` by coercing URL keys to strings before constructing the `Newsletter` model.

**Run WITHOUT Tavily (should warn but succeed)**
*Run from the repo root.*

```bash
export TAVILY_API_KEY=
python -m newsletter --topic "AI/ML/AGI" --tone "Professional" --audience "Researchers" --output-dir output
```

**Run WITH Tavily (uses `.env`)**
*Make sure your `.env` has a valid `TAVILY_API_KEY`.*

```bash
unset TAVILY_API_KEY
python -m newsletter --topic "AI/ML/AGI" --tone "Professional" --audience "Researchers" --output-dir output
```

**`WARNING: No TAVILY_API_KEY set`**
OK—research is optional. Set `TAVILY_API_KEY` to enrich citations.

**Tavily 401 Unauthorized**
If `TAVILY_API_KEY` is present but invalid, requests may fail.
Quick workaround: `unset TAVILY_API_KEY` to run without research.

**404 when serving with `http.server`**

* From repo root with `--directory output`: open `/newsletter.html`
* From inside `output/`: open `/newsletter.html`
* For `/` to work: `cp output/newsletter.html output/index.html`

**Virtualenv confusion**

```bash
. .venv/bin/activate     # Windows: .\.venv\Scripts\Activate.ps1
which python             # should be .venv/bin/python
```

**“Files not generated”**
If the run crashes (e.g., API error), nothing is written. Fix the error, then re-run with `--output-dir output`.

---

## Security

* Never commit real `.env`/API keys
* Rotate keys if exposed
* Consider rate limits/costs for provider APIs

---

## Production Considerations

* Error handling & retries around network calls
* Logging/monitoring of runs
* Caching for search results
* Rate limit/backoff policies
* Human review of content before sending
* Unsubscribe & compliance (CAN-SPAM/GDPR) for real lists
* Use MJML/inline-CSS templates for inbox compatibility

---

## Development

```bash
# Tests (when implemented)
pytest tests/

# Format
black newsletter/

# Lint
ruff check newsletter/

# Type check
mypy newsletter/
```

---